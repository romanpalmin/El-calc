PSEC.Controller=function(e,n){function o(n){var o=0;return o=n>=3e3&&1e5>n?e.rates.rate1:n>=1e5&&4e5>n?e.rates.rate2:n>=4e5&&5e5>=n?e.rates.rate3:0}function t(e,t){var a=s.properties[t].days;return a?n.Round(o(e)/100*e*a):0}function a(o,a,s,l){var i,m,c,d={},h=0,f=a/100,g=0,v=0,p=[],I=[],y=0,A=o,C=0,P=0,R=0,Y=0,b={periodIterator:0,amount:0,feeInPeriod:0,reinvest:0,cash:0,balance:0};for(m=0;s>m;m++)R=0,y=m,12===p.length&&p.shift(),0===I.length?(r&&console.log("Первый вклад"),A=A,C=t(A,l),h=+C*+f,g=A,h>=e.amount.min?(r&&console.log("Первый вклад, хватило на реинвест"),P=h,Y=0,R=C-Y-P):(r&&console.log("Первый вклад, не хватило на реинвест, скидываем на баланс"),P=0,Y=h,R=C-Y-P),v=R):(r&&console.log("Не первый вклад"),d=I[m-1],d.reinvest>=e.amount.min?(r&&console.log("Есть реинвест с предыдущего"),A=d.reinvest,C=t(A,l),c=u(p).feeInPeriod+C,h=+c*+f,h>=e.amount.min?(r&&console.log("Есть реинвест с предыдущего и есть средства на следующий"),P=h,Y=0,R=c-P):(r&&console.log("Есть реинвест с предыдущего, но нет бабла на новый. Нищебродский взнос."),P=0,Y+=h,R=c-Y)):(r&&console.log("Не хватает на реинвест, скидываем на баланс"),c=u(p).feeInPeriod,h=c*+f,r&&console.log("Не первый вклад, не хватает на реинвест"),A=0,P=0,C=0,R=c-h,Y+=h,Y>=e.amount.min&&(r&&console.log("Проверяем баланс, если хватает на реинвест, пересчитываем"),P=Y,Y=0)),g=u(p).totalAmount+A,v=u(I).totalCash+R),P>e.amount.max&&(R+=P-e.amount.max,v+=R,P=e.amount.max),b={periodIterator:y,amount:n.Round(A),totalAmount:n.Round(g),totalCash:n.Round(v),feeInPeriod:n.Round(C),reinvest:n.Round(P),cash:n.Round(R),balance:n.Round(Y)},p.push(b),I.push(b);return i={activeAmounts:p,summaryAmounts:I,currentSumAmounts:u(p).totalAmount,summaryCash:u(I).totalCash,restInBalance:u(p).restInBalance}}var r=!1;this.periodType={DAY:1,WEEK:2,MONTH:3,properties:{1:{name:"day",value:1,inYear:365,days:1},2:{name:"week",value:2,inYear:52,days:7},3:{name:"month",value:3,inYear:12,days:e.days/e.months}}};var s=this.periodType;this.Calculate=function(e,n,o,t){return a(e,n,o,t)};var u=function(e){for(var n={},o=0,t=[],a=0,r=0,s=0;s<e.length;s++)o+=e[s].feeInPeriod,a+=e[s].amount,t.push(e[s].feeInPeriod),r+=e[s].cash;return n.restInBalance=e[e.length-1].balance,n.feeInPeriod=o,n.listOfFees=t,n.totalAmount=a,12===e.length&&(n.totalAmount-=e[0].amount),n.totalCash=r,n}};