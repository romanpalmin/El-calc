PSEC.Controller=function(e,o){function n(o){var n=0;return n=o>=3e3&&1e5>o?e.rates.rate1:o>=1e5&&4e5>o?e.rates.rate2:o>=4e5&&5e5>=o?e.rates.rate3:0}function t(e,t){var a=s.properties[t].days;return a?o.Round(n(e)/100*e*a):0}function a(n,a,s,l){var i,m,c,d={},h=0,f=a/100,v=0,g=0,p=[],I=[],y=0,A=n,C=0,P=0,R=0,Y=0,b={periodIterator:0,amount:0,feeInPeriod:0,reinvest:0,cash:0,balance:0};for(m=0;s>m;m++)R=0,y=m,12===p.length&&p.shift(),0===I.length?(r&&console.log("Первый вклад"),A=A,C=t(A,l),h=+C*+f,v=A,h>=e.amount.min?(r&&console.log("Первый вклад, хватило на реинвест"),P=h,Y=0,R=C-Y-P):(r&&console.log("Первый вклад, не хватило на реинвест, скидываем на баланс"),P=0,Y=h,R=C-Y-P),g=R):(r&&console.log("Не первый вклад"),d=I[m-1],d.reinvest>=e.amount.min?(r&&console.log("Есть реинвест с предыдущего"),A=d.reinvest,C=t(A,l),c=u(p).feeInPeriod+C,h=+c*+f,h>=e.amount.min?(r&&console.log("Есть реинвест с предыдущего и есть средства на следующий"),P=h,Y=0,R=c-P):(r&&console.log("Есть реинвест с предыдущего, но нет бабла на новый. Нищебродский взнос."),P=0,Y+=h,R=c-Y)):(r&&console.log("Не хватает на реинвест, скидываем на баланс"),c=u(p).feeInPeriod,h=c*+f,r&&console.log("Не первый вклад, не хватает на реинвест"),A=0,P=0,C=0,Y+=h,R=c-h,Y>=e.amount.min&&(r&&console.log("Проверяем баланс, если хватает на реинвест, пересчитываем"),A=Y,C=t(A,l),h=(+C+t(u(p).totalAmount,l))*+f,P=h,Y=0,R=+C+t(u(p).totalAmount,l)-P)),v=u(p).totalAmount+A,g=u(I).totalCash+R),P>e.amount.max&&(R+=P-e.amount.max,g+=R,P=e.amount.max),b={periodIterator:y,amount:o.Round(A),totalAmount:o.Round(v),totalCash:o.Round(g),feeInPeriod:o.Round(C),reinvest:o.Round(P),cash:o.Round(R),balance:o.Round(Y)},p.push(b),I.push(b);return i={activeAmounts:p,summaryAmounts:I,currentSumAmounts:u(p).totalAmount,summaryCash:u(I).totalCash,restInBalance:u(p).restInBalance}}var r=!1;this.periodType={DAY:1,WEEK:2,MONTH:3,properties:{1:{name:"day",value:1,inYear:365,days:1},2:{name:"week",value:2,inYear:52,days:7},3:{name:"month",value:3,inYear:12,days:e.days/e.months}}};var s=this.periodType;this.Calculate=function(e,o,n,t){return a(e,o,n,t)};var u=function(e){for(var o={},n=0,t=[],a=0,r=0,s=0;s<e.length;s++)n+=e[s].feeInPeriod,a+=e[s].amount,t.push(e[s].feeInPeriod),r+=e[s].cash;return o.restInBalance=e[e.length-1].balance,o.feeInPeriod=n,o.listOfFees=t,o.totalAmount=a,o.totalCash=r,o}};